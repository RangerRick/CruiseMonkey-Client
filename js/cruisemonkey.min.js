!function(){"use strict";"function"!=typeof String.prototype.capitalize&&(String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1).toLowerCase()}),"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return 0===this.lastIndexOf(a,0)}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)})}(),function(){"use strict";angular.module("cruisemonkey.Config",[]).value("config.logging.useStringAppender",!1).value("config.database.host","cm.raccoonfink.com").value("config.database.name","cruisemonkey").value("config.database.replicate",!0).value("config.app.version","3.90")}(),function(){"use strict";angular.module("cruisemonkey.controllers.DeckList",["ngRoute","cruisemonkey.Logging","hammer"]).controller("CMDeckListCtrl",["$scope","$rootScope","$routeParams","$location","LoggingService",function(a,b,c,d,e){e.info("Initializing CMDeckListCtrl"),a.deck=parseInt(c.deck,10),b.title="Deck "+a.deck,a.previous=function(){f()},a.next=function(){g()};var f=function(){a.$apply(function(){if(2!==a.deck){var b=a.deck-1;e.info("previous() going down to deck "+b),d.path("/deck-plans/"+b)}})},g=function(){a.$apply(function(){if(15!==a.deck){var b=a.deck+1;e.info("next() going up to deck "+b),d.path("/deck-plans/"+b)}})},h=function(a){return console.log("received event: ",a),37===a.keyCode?(f(),!1):39===a.keyCode?(g(),!1):!0};document.addEventListener("keydown",h,!0),a.$on("$destroy",function(){document.removeEventListener("keydown",h,!0)})}])}(),function(){"use strict";angular.module("cruisemonkey.controllers.Events",["ngRoute","cruisemonkey.User","cruisemonkey.Events","cruisemonkey.Logging","ui.bootstrap.modal","datePicker"]).controller("CMEditEventCtrl",["$q","$scope","$modal","UserService","LoggingService",function(a,b,c,d,e){e.info("Initializing CMEditEventCtrl"),a.when(d.get()).then(function(a){var c=new Date;b.event={start:c,end:new Date(c.getTime()+36e5),type:"event",username:a.username}})}]).controller("CMEventCtrl",["$scope","$rootScope","$routeParams","$location","$q","$modal","$templateCache","UserService","EventService","LoggingService",function(a,b,c,d,e,f,g,h,i,j){j.info("Initializing CMEventCtrl"),a.eventType=c.eventType,b.title=c.eventType.capitalize()+" Events",b.actions=[],a.events||(a.events={}),e.when(h.get()).then(function(d){var g="";d.username&&(g=d.username),j.info("username = "+g),g&&""!==g&&b.actions.push({name:"Add Event",iconClass:"add",launch:function(){j.info("launching modal");var a=f.open({templateUrl:"edit-event.html",controller:"CMEditEventCtrl"});a.result.then(function(a){j.info("Add finished!"),i.addEvent(a)},function(){j.warn("Add canceled!")})}});var h;"official"===c.eventType?h=i.getOfficialEvents:"unofficial"===c.eventType?h=i.getPublicEvents:"my"===c.eventType?h=i.getMyEvents:j.warn("unknown event type: "+c.eventType),a.events=e.all([h(g),i.getMyFavorites(g)]).then(function(a){var b,c={};for(b=0;b<a[0].length;b++){var d=a[0][b];d.isFavorite=!1,c[d._id]=d}for(b=0;b<a[1].length;b++){var e=a[1][b];c[e]?c[e].isFavorite=!0:j.warn("could not find "+e+" in available events")}return c})}),a.onChange=function(b,c){e.when(h.get()).then(function(d){var f=d.username;e.when(a.events).then(function(a){a[b].isFavorite=c}),c?i.addFavorite(f,b):i.removeFavorite(f,b)})},a.safeApply=function(a){var b=this.$root.$$phase;"$apply"===b||"$digest"===b?a&&"function"==typeof a&&a():this.$apply(a)}}])}(),function(){"use strict";angular.module("cruisemonkey.controllers.Header",["cruisemonkey.Logging"]).controller("CMHeaderCtrl",["$scope","$rootScope","$location","LoggingService",function(a,b,c,d){d.info("Initializing CMHeaderCtrl")}])}(),function(){"use strict";angular.module("cruisemonkey.controllers.Login",["cruisemonkey.Logging","cruisemonkey.User"]).controller("CMLoginCtrl",["$scope","$rootScope","$location","UserService","LoggingService",function(a,b,c,d,e){e.info("Initializing CMLoginCtrl"),b.title="Log In",b.user=d.get(),a.isUnchanged=function(a){var b=d.get();return null===b||void 0===b?null===a||void 0===a?!0:!1:b.username===a.username&&b.password===a.password},a.reset=function(){var a=d.get();e.info("resetting user: ",a),b.user=a,b.$broadcast("cmUpdateMenu"),c.path("/events/official")},a.update=function(a){a.loggedIn=!0,e.info("saving user"),console.log(a),d.save(a),b.user=d.get(),b.$broadcast("cmUpdateMenu"),c.path("/events/my")}}])}(),function(){"use strict";angular.module("cruisemonkey.Navigation",["cruisemonkey.Logging"]).controller("CMNavigationCtrl",["$rootScope","$scope","$location","$document","UserService","LoggingService","$mobileFrame",function(a,b,c,d,e,f,g){f.info("Initializing CMNavigationCtrl"),b.toggleDrawer=function(){return g.navVisible()&&g.toggleNav(),!0}}])}(),function(){"use strict";angular.module("cruisemonkey.Database",["cruisemonkey.Logging","cruisemonkey.Config","ngInterval"]).factory("Database",["$location","$interval","LoggingService","config.database.host","config.database.name","config.database.replicate",function(a,b,c,d,e,f){c.info("Initializing CruiseMonkey database: "+e);var g=new Pouch(e),h=null,i=function(){if(f){if(null!==h)return c.warn("Replication has already been started!  Timeout ID = "+h),!1;d||(d=a.host());var e="http://"+d+":5984/cruisemonkey";return c.info("Enabling replication with "+e),h=b(function(){c.info("Attempting to replicate with "+e),g.replicate.to(e,{}),g.replicate.from(e,{})},1e4),!0}return c.warn("startReplication() called, but replication is not enabled!"),!1},j=function(){return f?null!==h?(c.info("Stopping replication with "+host),b.cancel(h),h=null,!0):(c.info("Replication is already stopped!"),!1):(c.warn("stopReplication() called, but replication is not enabled!"),void 0)},k=function(){void 0!==navigator.connection.type&&void 0!==Connection.WIFI?(console.log("Connection type is: "+navigator.connection.type),navigator.connection.type===Connection.NONE?j():i()):void 0!==navigator.connection.bandwidth&&(console.log("Connection bandwidth is: "+navigator.connection.bandwidth),navigator.connection.bandwidth>0?i():j())};return navigator&&navigator.connection?navigator.connection.addEventListener?(c.info("Browser has native navigator.connection support."),navigator.connection.addEventListener("change",k)):(c.info("Browser does not have native navigator.connection support.  Trying with phonegap."),document.addEventListener("online",k),document.addEventListener("offline",k)):(c.warn("Unsure how to handle connection management; starting replication and hoping for the best."),i()),c.info("Finished initializing CruiseMonkey database."),{database:g,startReplication:i,stopReplication:j}}]).factory("listener",["$rootScope","Database",function(a,b){b.database.changes({continuous:!0,onChange:function(c){c.deleted?a.$apply(function(){a.$broadcast("entryDeleted",c.id)}):a.$apply(function(){b.database.get(c.id,function(b,c){a.$apply(function(){b&&log.error(b),a.$broadcast("entryChange",c)})})})}})}])}(),function(){"use strict";angular.module("cruisemonkey.Events",["cruisemonkey.Database","cruisemonkey.Logging"]).factory("EventService",["$q","$rootScope","Database","UserService","LoggingService",function(a,b,c,d,e){var f=function(d,f){var g=a.defer();return c.database.query({map:d},f,function(a,c){b.$apply(function(){if(a)e.error(a),g.reject(a);else{var b,d=[];for(b=0;b<c.total_rows;b++)d.push(c.rows[b].value);g.resolve(d)}})}),g.promise};return{addEvent:function(f){f.type="event";var g=a.defer(),h=function(){e.info("addEvent(): posting event "+f.summary+" for user "+f.username),c.database.post(f,function(a,c){b.$apply(function(){a?(e.error(a),g.reject(a)):(f._id=c._id,f._rev=c._rev,g.resolve(f))})})};f.username&&""!==f.username?h():(e.info("addEvent(): no username in the event, attempting to get it from the UserService"),a.when(d.get()).then(function(a){a&&a.username&&""!==a.username?(f.username=a.username,h()):(e.error("addEvent() called, but we have no username!"),g.reject("username not found"))}))},removeEvent:function(d){e.info("removeEvent("+d._id+")");var f=a.defer();c.database.remove(function(a,c){b.$apply(function(){a?(e.error(a),f.reject(a)):f.resolve(c)})})},getAllEvents:function(){return e.info("getAllEvents()"),f(function(a){"event"===a.type&&emit(a.username,a)},{reduce:!1})},getOfficialEvents:function(){return e.info("getOfficialEvents()"),f(function(a){"event"===a.type&&emit(a.username,a)},{reduce:!1,key:"official"})},getPublicEvents:function(){return e.info("getPublicEvents()"),f(function(a){"event"===a.type&&a.isPublic&&emit(a.username,a)},{reduce:!1})},getUserEvents:function(a){return e.info("getUserEvents("+a+")"),a?f(function(a){"event"===a.type&&emit(a.username,a)},{reduce:!1,key:a}):[]},getMyEvents:function(d){if(e.info("getMyEvents("+d+")"),!d)return[];var f=a.defer();return c.database.query({map:function(a){"event"===a.type?emit(a.username,{_id:a._id,type:a.type}):"favorite"===a.type&&emit(a.username,{_id:a.eventId,type:a.type})}},{reduce:!0,include_docs:!0,key:d},function(a,c){b.$apply(function(){if(a)e.error(a),f.reject(a);else{var b,d,g=[];for(b=0;b<c.total_rows;b++)d=c.rows[b],"favorite"===d.value.type&&(d.doc.isFavorite=!0),g.push(d.doc);f.resolve(g)}})}),f.promise},getMyFavorites:function(d){if(!d)return[];var f=a.defer();return c.database.query({map:function(a){"favorite"===a.type&&emit(a.username,a.eventId)}},{reduce:!0,include_docs:!1,key:d},function(a,c){b.$apply(function(){if(a)e.error(a),f.reject(a);else{var b,d=[];for(b=0;b<c.total_rows;b++)d.push(c.rows[b].value);f.resolve(d)}})}),f.promise},isFavorite:function(d,f){if(!d||!f)return!1;var g=a.defer();return c.database.query({map:function(a){"favorite"===a.type&&emit({username:a.username,eventId:a.eventId})}},{reduce:!0,include_docs:!1,key:{username:d,eventId:f}},function(a,c){b.$apply(function(){a?(e.error(a),g.reject(a)):(console.log("isFavorite.res=",c),g.resolve(c.total_rows>0))})}),g.promise},addFavorite:function(d,f){if(console.log("addFavorite("+d+","+f+")"),!d||!f)return null;var g=a.defer();return c.database.post({type:"favorite",username:d,eventId:f},function(a,c){b.$apply(function(){a?(e.error(a),g.reject(a)):g.resolve(c.id)})}),g.promise},removeFavorite:function(d,f){if(console.log("removeFavorite("+d+","+f+")"),!d||!f)return null;var g=a.defer();return c.database.query({map:function(a){"favorite"===a.type&&emit({username:a.username,eventId:a.eventId},a._id)}},{reduce:!0,include_docs:!0,key:{username:d,eventId:f}},function(a,d){b.$apply(function(){if(a)e.error(a),g.reject(a);else if(console.log(d),d.total_rows>0){var f=d.rows[0].doc;c.database.remove(f,function(a,c){b.$apply(function(){a?(e.error(a),g.reject(a)):g.resolve(c)})})}else console.log("no results"),g.resolve(null)})}),g.promise}}}])}(),function(){"use strict";function a(){}a.prototype=new log4javascript.Appender,a.prototype.layout=new log4javascript.NullLayout,a.prototype.threshold=log4javascript.Level.DEBUG,a.prototype._saLogHistory="",a.prototype._saIndentLevel=0,a.prototype._getPrefix=function(){for(var a="",b=0;b<this._saIndentLevel;b++)a+=" ";return a},a.prototype._increaseIndentLevel=function(){this._saIndentLevel+=2},a.prototype._decreaseIndentLevel=function(){this._saIndentLevel-=2,this._saIndentLevel<0&&(this._saIndentLevel=0)},a.prototype._resetLogHistory=function(){this._saLogHistory="",this._saIndentLevel=0},a.prototype._addToLogHistory=function(a){void 0===this._saLogHistory?this._saLogHistory=this._getPrefix()+a+"\n":this._saLogHistory+=this._getPrefix()+a+"\n"},a.prototype.getLogHistory=function(){return this._saLogHistory||""},a.prototype.append=function(a){var b=this,c=function(){var c=b.getLayout(),d=c.format(a);return c.ignoresThrowable()&&a.exception&&(d+=a.getThrowableStrRep()),d};b._addToLogHistory(c())},a.prototype.group=function(a){this._addToLogHistory("=== "+a+" ==="),this._increaseIndentLevel()},a.prototype.groupEnd=function(){this._decreaseIndentLevel()},a.prototype.toString=function(){return"StringAppender"},angular.module("cruisemonkey.Logging",["cruisemonkey.Config"]).factory("LoggingService",["config.logging.useStringAppender",function(b){console.log("initializing LoggingService");var c=log4javascript.getLogger();c.removeAllAppenders();var d={getLogHistory:function(){return""},trace:function(){c.trace(Array.prototype.slice.apply(arguments))},debug:function(){c.debug(Array.prototype.slice.apply(arguments))},info:function(){c.info(Array.prototype.slice.apply(arguments))},warn:function(){c.warn(Array.prototype.slice.apply(arguments))},warning:function(){c.warn(Array.prototype.slice.apply(arguments))},error:function(){c.error(Array.prototype.slice.apply(arguments))},fatal:function(){c.fatal(Array.prototype.slice.apply(arguments))}};if(b){console.log("initializing StringAppender");var e=new a;e.setLayout(new log4javascript.PatternLayout("%d{HH:mm:ss,SSS} [%-5p] %m")),c.addAppender(e),d.getLogHistory=function(){return e.getLogHistory()}}else console.log("skipping StringAppender");var f=new log4javascript.BrowserConsoleAppender;return f.setLayout(new log4javascript.PatternLayout("%d{HH:mm:ss,SSS} [%-5p] %m")),c.addAppender(f),d}])}(),function(){"use strict";angular.module("cruisemonkey.User",[]).factory("UserService",function(){var a={loggedIn:!1,username:"",password:""};return{loggedIn:function(){return a.loggedIn},get:function(){return angular.copy(a)},save:function(b){a=angular.copy(b)}}})}(),function(){"use strict";angular.module("cruisemonkey.directives",[])}(),function(){"use strict";angular.module("cruisemonkey.filters",[])}(),function(){"use strict";angular.module("cruisemonkey.services",[]).value("version","3.90")}(),function(){"use strict";angular.module("cruisemonkey",["ngRoute","cruisemonkey.filters","cruisemonkey.services","cruisemonkey.directives","cruisemonkey.controllers.DeckList","cruisemonkey.controllers.Events","cruisemonkey.controllers.Header","cruisemonkey.controllers.Login","cruisemonkey.Database","cruisemonkey.Navigation","cruisemonkey.Events","cruisemonkey.User","ek.mobileFrame","btford.phonegap.ready"]).config(["$routeProvider","$mobileFrameProvider",function(a,b){a.when("/login",{templateUrl:"template/login.html",controller:"CMLoginCtrl"}).when("/events",{redirectTo:"/events/official/"}).when("/events/:eventType",{templateUrl:"template/event-list.html",controller:"CMEventCtrl"}).when("/deck-plans",{redirectTo:"/deck-plans/2/"}).when("/deck-plans/:deck",{templateUrl:"template/deck-plans.html",controller:"CMDeckListCtrl"}).otherwise({redirectTo:"/events/official/"}),b.setHeaderHeight(40).setFooterHeight(0).setNavWidth(250)}]).run(["$rootScope","$location","UserService","phonegapReady",function(a,b,c,d){d(function(){7===parseFloat(window.device.version)&&(document.body.style.marginTop="20px")}),a.$on("$routeChangeStart",function(d,e,f){return a.actions=[],a.user=c.get(),c.loggedIn()?(angular.noop(),void 0):"template/event-list.html"===e.templateUrl&&"my"===e.params.eventType?(d.preventDefault(),b.path("/login/"),angular.noop(),void 0):(f&&f.access&&f.access.requiresLogin&&(d.preventDefault(),b.path("/login/"),angular.noop()),angular.noop(),void 0)});var e=function(){var a=b.path();angular.forEach(document.getElementById("nav").children,function(b){if(b.children[0]){var c=b.children[0].href,d=c.indexOf("#");-1!==d&&(c=c.substring(c.indexOf("#")+1)),a.startsWith(c)?angular.element(b).addClass("selected"):angular.element(b).removeClass("selected")}})};a.$on("$routeChangeSuccess",function(){e()}),a.$on("cmUpdateMenu",function(){console.log("cmUpdateMenu fired"),e()})}])}();